<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TickTrax Security Demo</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            background: #f8fafc;
        }
        .section { 
            background: white;
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .demo-button { 
            background: #3b82f6; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px;
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
        }
        .demo-button:hover { background: #2563eb; }
        .success { color: #059669; background: #ecfdf5; padding: 10px; border-radius: 4px; }
        .error { color: #dc2626; background: #fef2f2; padding: 10px; border-radius: 4px; }
        .info { color: #0891b2; background: #f0f9ff; padding: 10px; border-radius: 4px; }
        .token-display { 
            font-family: monospace; 
            background: #1f2937; 
            color: #e5e7eb; 
            padding: 15px; 
            border-radius: 6px; 
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .concept { 
            border-left: 4px solid #3b82f6; 
            padding-left: 16px; 
            margin: 15px 0;
        }
        h1 { color: #1f2937; }
        h2 { color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        h3 { color: #4b5563; }
    </style>
</head>
<body>
    <h1>üîê TickTrax Security Implementation Demo</h1>
    <p class="info">This page demonstrates all the security concepts implemented in the TickTrax application.</p>

    <!-- 1. JWT TOKEN MANAGEMENT -->
    <div class="section">
        <h2>1. JWT Token Management</h2>
        <div class="concept">
            <h3>‚úÖ Features Implemented:</h3>
            <ul>
                <li><strong>JWT Structure Validation:</strong> Validates 3-part structure (header.payload.signature)</li>
                <li><strong>Expiration Checking:</strong> Parses 'exp' claim and validates against current time</li>
                <li><strong>Automatic Token Refresh:</strong> Schedules refresh 5 minutes before expiration</li>
                <li><strong>Secure Storage:</strong> Stores in localStorage with automatic cleanup</li>
                <li><strong>Payload Parsing:</strong> Extracts user info (id, email, role) from JWT payload</li>
            </ul>
        </div>
        
        <button class="demo-button" onclick="demoJWT()">Demo JWT Token Validation</button>
        <button class="demo-button" onclick="showCurrentJWT()">Show Current JWT Token</button>
        <div id="jwt-result"></div>
    </div>

    <!-- 2. XSRF TOKEN PROTECTION -->
    <div class="section">
        <h2>2. XSRF Token Protection</h2>
        <div class="concept">
            <h3>‚úÖ CSRF Protection Implementation:</h3>
            <ul>
                <li><strong>XSRF Token Storage:</strong> Securely stored alongside JWT token</li>
                <li><strong>Header Integration:</strong> Automatically added to all authenticated requests</li>
                <li><strong>Dual Header Support:</strong> Both 'X-CSRF-Token' and 'x-csrf-token' headers</li>
                <li><strong>Synchronized Updates:</strong> XSRF token updated with JWT token refresh</li>
            </ul>
        </div>
        
        <button class="demo-button" onclick="demoXSRF()">Demo XSRF Token</button>
        <button class="demo-button" onclick="showAuthHeaders()">Show Auth Headers</button>
        <div id="xsrf-result"></div>
    </div>

    <!-- 3. AUTHENTICATION MANAGEMENT -->
    <div class="section">
        <h2>3. Authentication Management</h2>
        <div class="concept">
            <h3>‚úÖ Secure Authentication Flow:</h3>
            <ul>
                <li><strong>Password Security:</strong> Never logged in production, hashed on backend</li>
                <li><strong>Token Lifecycle:</strong> Automatic initialization, refresh, and cleanup</li>
                <li><strong>Session Management:</strong> Persistent across browser sessions</li>
                <li><strong>Logout Cleanup:</strong> Complete token and state cleanup</li>
                <li><strong>Fallback Handling:</strong> Graceful degradation when API unavailable</li>
            </ul>
        </div>
        
        <button class="demo-button" onclick="testLogin()">Test Login Flow</button>
        <button class="demo-button" onclick="checkAuthStatus()">Check Auth Status</button>
        <button class="demo-button" onclick="testLogout()">Test Logout</button>
        <div id="auth-result"></div>
    </div>

    <!-- 4. ROUTING WITH BEFOREEACH -->
    <div class="section">
        <h2>4. Vue Router with beforeEach() Navigation Guards</h2>
        <div class="concept">
            <h3>‚úÖ Route Protection Implementation:</h3>
            <ul>
                <li><strong>Authentication Guards:</strong> Validates JWT token before each route</li>
                <li><strong>Role-Based Access:</strong> Checks user role against required permissions</li>
                <li><strong>Redirect Logic:</strong> Automatic redirects for unauthorized access</li>
                <li><strong>Token Validation:</strong> Server-side validation with fallback</li>
                <li><strong>Navigation Logging:</strong> Comprehensive security logging</li>
            </ul>
        </div>
        
        <button class="demo-button" onclick="testRouting()">Test Protected Routes</button>
        <button class="demo-button" onclick="showRouterInfo()">Show Router Configuration</button>
        <div id="router-result"></div>
    </div>

    <!-- 5. PASSWORD HASHING (BACKEND) -->
    <div class="section">
        <h2>5. Password Hashing (Backend Implementation)</h2>
        <div class="concept">
            <h3>‚úÖ Backend Security (Phoenix/Elixir):</h3>
            <ul>
                <li><strong>Bcrypt Hashing:</strong> Industry-standard password hashing</li>
                <li><strong>Salt Generation:</strong> Unique salt for each password</li>
                <li><strong>Never Stored Plain:</strong> Passwords never stored in plain text</li>
                <li><strong>Comparison Security:</strong> Secure hash comparison for login</li>
                <li><strong>Frontend Safety:</strong> Passwords never logged on frontend</li>
            </ul>
        </div>
        
        <button class="demo-button" onclick="demoPasswordSecurity()">Demo Password Security</button>
        <div id="password-result"></div>
    </div>

    <script>
        // Access the authentication manager
        const authManager = window.authManager;

        function demoJWT() {
            const resultDiv = document.getElementById('jwt-result');
            
            if (!authManager) {
                resultDiv.innerHTML = '<div class="error">AuthManager not available in this environment</div>';
                return;
            }

            // Demo JWT token validation
            const token = authManager.jwtToken || localStorage.getItem('jwt_token');
            
            if (token) {
                const isValid = authManager.isValidJwtStructure(token);
                const isExpired = authManager.isJwtExpired(token);
                const payload = authManager.parseJwtPayload(token);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>JWT Token Analysis:</h4>
                        <p><strong>Structure Valid:</strong> ${isValid}</p>
                        <p><strong>Is Expired:</strong> ${isExpired}</p>
                        <p><strong>Payload:</strong></p>
                        <div class="token-display">${JSON.stringify(payload, null, 2)}</div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<div class="info">No JWT token found. Please login first.</div>';
            }
        }

        function showCurrentJWT() {
            const resultDiv = document.getElementById('jwt-result');
            const token = authManager?.jwtToken || localStorage.getItem('jwt_token');
            
            if (token) {
                resultDiv.innerHTML = `
                    <div class="info">
                        <h4>Current JWT Token:</h4>
                        <div class="token-display">${token}</div>
                        <p><strong>Length:</strong> ${token.length} characters</p>
                        <p><strong>Parts:</strong> ${token.split('.').length} (should be 3)</p>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<div class="info">No JWT token stored</div>';
            }
        }

        function demoXSRF() {
            const resultDiv = document.getElementById('xsrf-result');
            
            if (!authManager) {
                resultDiv.innerHTML = '<div class="error">AuthManager not available</div>';
                return;
            }

            const xsrfToken = authManager.getXsrfToken();
            
            if (xsrfToken) {
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>XSRF Token Protection:</h4>
                        <p><strong>Token Present:</strong> ‚úÖ Yes</p>
                        <p><strong>Token Length:</strong> ${xsrfToken.length} characters</p>
                        <div class="token-display">${xsrfToken}</div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = '<div class="info">No XSRF token found. Login to generate one.</div>';
            }
        }

        function showAuthHeaders() {
            const resultDiv = document.getElementById('xsrf-result');
            
            if (!authManager) {
                resultDiv.innerHTML = '<div class="error">AuthManager not available</div>';
                return;
            }

            const headers = authManager.getAuthHeaders();
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>Authentication Headers:</h4>
                    <div class="token-display">${JSON.stringify(headers, null, 2)}</div>
                    <p><strong>JWT Authorization:</strong> ${headers.Authorization ? '‚úÖ Present' : '‚ùå Missing'}</p>
                    <p><strong>XSRF Protection:</strong> ${headers['x-csrf-token'] ? '‚úÖ Present' : '‚ùå Missing'}</p>
                </div>
            `;
        }

        async function testLogin() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<div class="info">Testing login flow...</div>';
            
            if (!authManager) {
                resultDiv.innerHTML = '<div class="error">AuthManager not available</div>';
                return;
            }

            try {
                const result = await authManager.login('xinxin@epitech.eu', 'xinxin123');
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>Login Successful! ‚úÖ</h4>
                            <p><strong>User:</strong> ${result.user.email}</p>
                            <p><strong>Role:</strong> ${result.user.role}</p>
                            <p><strong>JWT Token:</strong> ${result.token ? 'Generated' : 'Not provided'}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">Login failed: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Login error: ${error.message}</div>`;
            }
        }

        async function checkAuthStatus() {
            const resultDiv = document.getElementById('auth-result');
            
            if (!authManager) {
                resultDiv.innerHTML = '<div class="error">AuthManager not available</div>';
                return;
            }

            try {
                const isAuth = await authManager.isAuthenticated();
                const currentUser = await authManager.getCurrentUser();
                
                resultDiv.innerHTML = `
                    <div class="${isAuth ? 'success' : 'info'}">
                        <h4>Authentication Status:</h4>
                        <p><strong>Authenticated:</strong> ${isAuth ? '‚úÖ Yes' : '‚ùå No'}</p>
                        <p><strong>Current User:</strong> ${currentUser.success ? currentUser.data.email : 'None'}</p>
                        <p><strong>JWT Token:</strong> ${authManager.jwtToken ? 'Present' : 'Missing'}</p>
                        <p><strong>XSRF Token:</strong> ${authManager.xsrfToken ? 'Present' : 'Missing'}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Auth check failed: ${error.message}</div>`;
            }
        }

        async function testLogout() {
            const resultDiv = document.getElementById('auth-result');
            
            if (!authManager) {
                resultDiv.innerHTML = '<div class="error">AuthManager not available</div>';
                return;
            }

            try {
                const result = await authManager.logout();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>Logout ${result.success ? 'Successful' : 'Failed'} ‚úÖ</h4>
                        <p><strong>JWT Token Cleared:</strong> ${!authManager.jwtToken ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>XSRF Token Cleared:</strong> ${!authManager.xsrfToken ? '‚úÖ' : '‚ùå'}</p>
                        <p><strong>LocalStorage Cleaned:</strong> ${!localStorage.getItem('jwt_token') ? '‚úÖ' : '‚ùå'}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Logout error: ${error.message}</div>`;
            }
        }

        function testRouting() {
            const resultDiv = document.getElementById('router-result');
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>Router Navigation Guards Testing:</h4>
                    <p>Try these protected routes (check console for beforeEach logs):</p>
                    <div style="margin: 10px 0;">
                        <a href="/dashboard" target="_blank" style="display: inline-block; margin: 5px; padding: 8px 16px; background: #3b82f6; color: white; text-decoration: none; border-radius: 4px;">Dashboard (Auth Required)</a>
                        <a href="/dashboard/admin" target="_blank" style="display: inline-block; margin: 5px; padding: 8px 16px; background: #ef4444; color: white; text-decoration: none; border-radius: 4px;">Admin Only</a>
                        <a href="/dashboard/manager" target="_blank" style="display: inline-block; margin: 5px; padding: 8px 16px; background: #f59e0b; color: white; text-decoration: none; border-radius: 4px;">Manager+</a>
                        <a href="/nonexistent" target="_blank" style="display: inline-block; margin: 5px; padding: 8px 16px; background: #6b7280; color: white; text-decoration: none; border-radius: 4px;">404 Test</a>
                    </div>
                    <p><strong>Navigation Logic:</strong></p>
                    <ul>
                        <li>üîí Protected routes require valid JWT token</li>
                        <li>üë§ Role-based routes check user permissions</li>
                        <li>üîÑ Automatic redirects for unauthorized access</li>
                        <li>üìã All navigation logged in console</li>
                    </ul>
                </div>
            `;
        }

        function showRouterInfo() {
            const resultDiv = document.getElementById('router-result');
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>Router Configuration:</h4>
                    <div class="token-display">
// beforeEach Navigation Guard Implementation:
router.beforeEach(async (to, from, next) => {
  // 1. Check if route requires authentication
  if (to.meta.requiresAuth) {
    // 2. Validate JWT token
    const isAuthenticated = await authManager.isAuthenticated()
    
    if (!isAuthenticated) {
      // 3. Redirect to login with return URL
      next({ path: '/login', query: { redirect: to.fullPath } })
      return
    }

    // 4. Check role-based access
    if (to.meta.requiresRole) {
      const currentUser = await authManager.getCurrentUser()
      const userRole = currentUser.data.role
      
      if (!to.meta.requiresRole.includes(userRole)) {
        // 5. Redirect to unauthorized page
        next('/unauthorized')
        return
      }
    }
  }
  
  // 6. Allow navigation
  next()
})
                    </div>
                </div>
            `;
        }

        function demoPasswordSecurity() {
            const resultDiv = document.getElementById('password-result');
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>Password Security Implementation:</h4>
                    <p><strong>Frontend (JavaScript):</strong></p>
                    <ul>
                        <li>‚úÖ Passwords never logged in production</li>
                        <li>‚úÖ Transmitted over HTTPS only</li>
                        <li>‚úÖ Cleared from memory after login</li>
                        <li>‚úÖ Input validation before sending</li>
                    </ul>
                    
                    <p><strong>Backend (Phoenix/Elixir):</strong></p>
                    <div class="token-display">
# Elixir password hashing with Bcrypt
defmodule UserController do
  def create_user(params) do
    hashed_password = Bcrypt.hash_pwd_salt(params["password"])
    
    user = %User{
      email: params["email"],
      password_hash: hashed_password  # Only hash stored
    }
    
    Repo.insert(user)
  end
  
  def authenticate(email, password) do
    user = Repo.get_by(User, email: email)
    
    if user && Bcrypt.verify_pass(password, user.password_hash) do
      {:ok, user}
    else
      {:error, :invalid_credentials}
    end
  end
end
                    </div>
                    
                    <p><strong>Security Features:</strong></p>
                    <ul>
                        <li>üîê Bcrypt with automatic salt generation</li>
                        <li>‚è±Ô∏è Configurable work factor (computational cost)</li>
                        <li>üõ°Ô∏è Timing attack protection</li>
                        <li>üóÑÔ∏è Only hashes stored in database</li>
                    </ul>
                </div>
            `;
        }

        // Initialize demo on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Security Demo Page Loaded');
            console.log('Available functions:', {
                authManager: !!window.authManager,
                testProfile: !!window.testProfile
            });
        });
    </script>
</body>
</html>